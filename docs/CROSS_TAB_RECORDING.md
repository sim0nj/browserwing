# 跨标签页录制功能

## 功能概述

现在录制功能支持跨多个标签页进行操作录制和回放。当用户在录制过程中打开新标签页时,系统会自动:

1. **检测新标签页创建** - 实时监听浏览器中新标签页的创建
2. **自动注入录制脚本** - 在新标签页中自动注入录制器UI和脚本
3. **记录跨标签页操作** - 自动记录 `open_tab` 动作,包含目标URL
4. **同步所有操作** - 从所有标签页同步录制的操作,按时间戳排序

## 实现细节

### 后端变更

#### 1. Recorder (recorder.go)

**新增字段:**
```go
type Recorder struct {
    pages  map[string]*rod.Page  // 跟踪所有录制的标签页
    // ... 其他字段
}
```

**核心功能:**

- `watchForNewPages()` - 每秒检查是否有新标签页创建
- `injectRecordingScriptToPage()` - 向新标签页注入录制脚本和UI
- `syncActionsFromBrowser()` - 从所有标签页同步操作,去重并排序

**录制流程:**
1. 用户开始录制时,主页面被添加到 `pages` map
2. 后台协程持续监听新标签页创建
3. 检测到新标签页时:
   - 注入录制脚本和UI面板
   - 记录 `open_tab` 动作
   - 将新页面添加到 `pages` map
4. 定期从所有页面同步操作到后端
5. 停止录制时,从所有页面收集最终操作并合并

#### 2. Player (player.go)

**新增字段:**
```go
type Player struct {
    pages        map[int]*rod.Page  // 多标签页支持
    currentPage  *rod.Page          // 当前活动页面
    tabCounter   int                // 标签页计数器
    // ... 其他字段
}
```

**新增操作类型:**

- `open_tab` - 打开新标签页
  ```go
  action.Type = "open_tab"
  action.URL = "https://example.com"
  ```

- `switch_tab` - 切换标签页
  ```go
  action.Type = "switch_tab"
  action.Value = "0"  // 标签页索引
  ```

**执行逻辑:**
- `executeOpenTab()` - 创建新标签页并导航到指定URL
- `executeSwitchTab()` - 切换到指定索引的标签页
- 所有其他操作使用 `currentPage` 作为目标页面

#### 3. Models (script.go)

**更新操作类型:**
```go
Type string  // 新增: open_tab, switch_tab
```

### 前端变更

#### ScriptManager.tsx

**新增UI元素:**

1. **添加操作按钮** - 新增"+ 新标签页"按钮用于手动添加 `open_tab` 步骤

2. **编辑界面** - `open_tab` 和 `switch_tab` 的编辑表单:
   - `open_tab`: URL 输入框
   - `switch_tab`: 标签页索引输入框

3. **只读显示** - 在脚本查看时正确显示标签页操作信息

## 使用场景

### 场景 1: 跨站操作
用户需要从网站A获取数据,然后在网站B中使用该数据:

1. 开始录制,在网站A操作
2. 用户通过 Ctrl+Click 或右键打开新标签页到网站B
3. 录制器自动检测并注入UI到新标签页
4. 继续在网站B中操作
5. 停止录制,生成包含 `open_tab` 动作的完整脚本

### 场景 2: 多账号操作
需要在多个标签页中同时操作多个账号:

1. 在标签页1登录账号A并操作
2. 打开新标签页登录账号B
3. 在不同标签页间切换并执行操作
4. 所有操作按时间顺序记录

### 场景 3: 信息对比
在不同标签页中对比和收集信息:

1. 在多个产品页面间切换
2. 从每个页面提取数据
3. 生成包含多标签页导航和数据提取的脚本

## 技术特点

### 1. 实时监听
- 使用定时轮询(1秒)检测新标签页
- 低开销,不阻塞主线程

### 2. 自动注入
- 新标签页加载完成后自动注入录制脚本
- 保持录制状态跨页面持久化
- 禁用CSP限制确保脚本执行

### 3. 操作同步
- 从所有标签页并行收集操作
- 使用时间戳进行全局排序
- 去重确保操作唯一性

### 4. 会话存储
- 使用 `sessionStorage` 跨页面保存操作
- 即使页面刷新也不丢失录制数据
- 支持页面导航的操作持久化

## 限制和注意事项

1. **同域限制** - 某些网站的严格安全策略可能阻止脚本注入
2. **性能考虑** - 大量标签页可能影响录制性能
3. **标签页索引** - 回放时标签页索引从0开始,需要按创建顺序执行
4. **弹出窗口** - 目前仅支持标签页,不支持弹出窗口

## 未来改进

- [ ] 支持标签页关闭操作的录制
- [ ] 支持标签页拖拽重排序
- [ ] 优化标签页切换的智能识别
- [ ] 添加标签页名称/URL的可视化提示
- [ ] 支持iframe中的跨标签页操作

## 测试建议

### 录制测试
1. 开始录制
2. 在原页面执行一些操作
3. 打开新标签页(Ctrl+Click链接)
4. 确认新标签页显示录制UI
5. 在新标签页执行操作
6. 停止录制并查看操作列表

### 回放测试
1. 选择包含 `open_tab` 的脚本
2. 开始回放
3. 确认新标签页正确打开
4. 确认操作在正确的标签页执行
5. 检查数据提取是否正确

## 相关文件

- `backend/services/browser/recorder.go` - 录制器核心逻辑
- `backend/services/browser/player.go` - 回放器核心逻辑
- `backend/models/script.go` - 脚本数据模型
- `frontend/src/pages/ScriptManager.tsx` - 脚本管理UI
