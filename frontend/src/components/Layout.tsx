import { Outlet, Link, useLocation, useNavigate } from 'react-router-dom'
import { Chrome, FileCode, Brain, Languages, MessageSquare, Sun, Moon, Settings, LogOut } from 'lucide-react'
import { useLanguage, LANGUAGES } from '../i18n'
import { useState, useRef, useEffect } from 'react'
import { useTheme } from '../contexts/ThemeContext'
import { CURRENT_VERSION, fetchLatestVersion, hasNewVersion, isVersionDismissed, dismissVersion, VersionInfo } from '../utils/version'
import VersionUpdateDialog from './VersionUpdateDialog'
import { logout, checkAuth } from '../api/client'

export default function Layout() {
  const location = useLocation()
  const navigate = useNavigate()
  const { t, language, setLanguage } = useLanguage()
  const { theme, toggleTheme } = useTheme()
  const [showLangMenu, setShowLangMenu] = useState(false)
  const [showUserMenu, setShowUserMenu] = useState(false)
  const [showUpdateDialog, setShowUpdateDialog] = useState(false)
  const [latestVersionInfo, setLatestVersionInfo] = useState<VersionInfo | null>(null)
  const [authEnabled, setAuthEnabled] = useState(false)
  const [username, setUsername] = useState<string>('')
  const langMenuRef = useRef<HTMLDivElement>(null)
  const userMenuRef = useRef<HTMLDivElement>(null)

  const isActive = (path: string) => {
    return location.pathname === path
  }

  const navItems = [
    { path: '/agent', labelKey: 'nav.agent', icon: MessageSquare },
    { path: '/browser', labelKey: 'nav.browser', icon: Chrome },
    { path: '/scripts', labelKey: 'nav.scripts', icon: FileCode },
    { path: '/llm', labelKey: 'nav.llm', icon: Brain },
  ]

  // 检查是否启用认证并获取用户信息
  useEffect(() => {
    const checkAuthStatus = async () => {
      const enabled = await checkAuth()
      setAuthEnabled(enabled)
      if (enabled) {
        const userStr = localStorage.getItem('user')
        if (userStr) {
          try {
            const user = JSON.parse(userStr)
            setUsername(user.username || '')
          } catch (e) {
            console.error('Failed to parse user info:', e)
          }
        }
      }
    }
    checkAuthStatus()
  }, [])

  // 点击外部关闭菜单
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (langMenuRef.current && !langMenuRef.current.contains(event.target as Node)) {
        setShowLangMenu(false)
      }
      if (userMenuRef.current && !userMenuRef.current.contains(event.target as Node)) {
        setShowUserMenu(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  // 检查版本更新
  useEffect(() => {
    const checkVersion = async () => {
      const versionInfo = await fetchLatestVersion()
      if (versionInfo && hasNewVersion(CURRENT_VERSION, versionInfo.version)) {
        // 检查用户是否已经关闭过这个版本的更新提示
        if (!isVersionDismissed(versionInfo.version)) {
          setLatestVersionInfo(versionInfo)
          setShowUpdateDialog(true)
        }
      }
    }
    // 延迟2秒后检查，避免影响首次加载
    const timer = setTimeout(checkVersion, 2000)
    return () => clearTimeout(timer)
  }, [])

  const handleDismissUpdate = () => {
    if (latestVersionInfo) {
      dismissVersion(latestVersionInfo.version)
      setShowUpdateDialog(false)
    }
  }

  return (
    <div className="min-h-screen flex flex-col relative bg-gradient-to-br from-gray-50 via-white to-blue-50 dark:from-gray-900 dark:via-gray-900 dark:to-gray-800">
      {/* 背景装饰元素 */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none" style={{ zIndex: 0 }}>
        <div className="absolute -top-24 left-1/4 w-[500px] h-[500px] rounded-full opacity-30 blur-3xl dark:opacity-20" style={{ background: 'radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%)' }} />
        <div className="absolute -bottom-24 right-1/4 w-[500px] h-[500px] rounded-full opacity-30 blur-3xl dark:opacity-20" style={{ background: 'radial-gradient(circle, rgba(168, 85, 247, 0.15) 0%, transparent 70%)' }} />
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[700px] h-[700px] rounded-full opacity-20 blur-3xl dark:opacity-10" style={{ background: 'radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%)' }} />
      </div>

      {/* Header - Notion风格 */}
      <header className="sticky top-0 bg-white/70 dark:bg-gray-900/70 border-b border-gray-200/60 dark:border-gray-700/60" style={{ zIndex: 50, backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)', fontFamily: 'Space Grotesk, Noto Sans SC, PingFang SC, Microsoft YaHei, system-ui, -apple-system, sans-serif' }}>
        <div className="max-w-[1400px] 2xl:max-w-[1600px] mx-auto px-6 lg:px-10 xl:px-12">
          <div className="flex items-center justify-between h-16 lg:h-18">
            <Link to="/" className="flex items-center space-x-3 group">
              {/* BrowserWing Logo */}
              <div className="w-10 h-10 lg:w-11 lg:h-11 bg-white dark:bg-gray-900 rounded-lg flex items-center justify-center group-hover:bg-gray-50 dark:group-hover:bg-gray-800 transition-all duration-300 group-hover:scale-105 p-0.5">
                <svg className="w-full h-full" viewBox="100 150 700 700" xmlns="http://www.w3.org/2000/svg">
                  <path className="fill-gray-900 dark:fill-gray-100" d="m333.65991,204.61905c1.60298,-0.00347 3.20596,-0.00824 4.80894,-0.01418c4.35264,-0.01239 8.70509,-0.0064 13.05774,0.00296c4.71447,0.00684 9.4289,-0.00372 14.14336,-0.01194c9.21503,-0.01329 18.42998,-0.01048 27.64501,-0.00176c7.49421,0.00679 14.9884,0.00768 22.48261,0.00442c1.60445,-0.00069 1.60445,-0.00069 3.2413,-0.00139c2.17344,-0.00096 4.34687,-0.00193 6.5203,-0.00292c20.34486,-0.00854 40.68968,0.00126 61.03454,0.0174c17.42874,0.01341 34.85743,0.01108 52.28617,-0.00275c20.27575,-0.01608 40.55147,-0.02236 60.82722,-0.01317c2.16511,0.00096 4.33021,0.0019 6.49532,0.00283c1.06507,0.00047 2.13014,0.00093 3.22748,0.00141c7.47877,0.00258 14.95751,-0.00177 22.43628,-0.00885c9.12333,-0.00844 18.24658,-0.00607 27.3699,0.00985c4.64823,0.00784 9.29633,0.01104 13.94456,0.00105c4.26614,-0.00903 8.53203,-0.00388 12.79815,0.01193c1.53209,0.00332 3.06419,0.00173 4.59626,-0.00562c14.18885,-0.06286 28.1027,1.61136 41.48745,6.57918c0.8316,0.30188 1.66321,0.60377 2.52002,0.9148c18.18978,6.78248 33.36074,16.51607 47.41748,29.8977c1.04994,0.90299 1.04994,0.90299 2.12109,1.82422c12.49771,11.30527 21.61476,27.67342 27.87891,43.17578c0.38285,0.88945 0.7657,1.77891 1.16015,2.69531c8.05481,20.02983 7.41853,40.78809 7.34809,61.96421c-0.01121,4.69878 0.00086,9.39751 0.00984,14.09628c0.01387,9.18035 0.00643,18.36057 -0.00868,27.54092c-0.01694,10.71032 -0.01364,21.4206 -0.0099,32.13092c0.00586,19.12042 -0.00825,38.24078 -0.03295,57.36118c-0.02392,18.5176 -0.031,37.03512 -0.02051,55.55273c0.01143,20.2073 0.01332,40.41455 -0.0011,60.62184c-0.00152,2.15807 -0.00304,4.31614 -0.00456,6.47422c-0.00075,1.06157 -0.00151,2.12314 -0.00229,3.21688c-0.00473,7.45077 -0.00291,14.90152 0.00136,22.35229c0.00495,9.08958 -0.00115,18.17909 -0.0209,27.26866c-0.00981,4.63013 -0.01504,9.26014 -0.0071,13.89028c0.00713,4.25071 0.00007,8.50115 -0.01761,12.75182c-0.00399,1.52531 -0.00312,3.05064 0.00352,4.57594c0.0614,15.42639 -1.85464,30.34188 -7.58486,44.75652c-0.3951,1.01868 -0.7902,2.03736 -1.19727,3.08691c-12.69623,31.92341 -37.97276,57.94732 -69.42285,71.76807c-3.93883,1.60799 -7.94211,2.94961 -12.00488,4.20752c-0.73243,0.23042 -1.46486,0.46084 -2.21948,0.69824c-20.21469,5.8449 -40.71829,5.43189 -61.543,5.39609c-4.68651,-0.00477 -9.37297,0.00782 -14.05947,0.01802c-9.15626,0.01711 -18.31245,0.01805 -27.46873,0.01279c-7.44696,-0.00406 -14.89389,-0.00258 -22.34085,0.00275c-1.06352,0.00075 -2.12704,0.00149 -3.22278,0.00226c-2.16111,0.00154 -4.32222,0.00307 -6.48333,0.00462c-20.22091,0.0137 -40.44178,0.00831 -60.66268,-0.00319c-18.468,-0.00993 -36.93591,0.00302 -55.40389,0.02694c-19.00525,0.02442 -38.01045,0.03399 -57.01571,0.02735c-10.65322,-0.00349 -21.30635,-0.00132 -31.95955,0.01625c-9.06581,0.01476 -18.13149,0.0153 -27.1973,-0.00207c-4.61802,-0.00848 -9.23582,-0.01074 -13.85383,0.00465c-4.23966,0.01395 -8.47888,0.00894 -12.71851,-0.01024c-1.52127,-0.00373 -3.04259,-0.00094 -4.56383,0.00961c-33.7581,0.2171 -64.88712,-15.04254 -88.72456,-38.32907c-23.26412,-23.45994 -37.09417,-56.17284 -37.14657,-89.23801c0.00717,-1.45249 0.01463,-2.90499 0.02235,-4.35748c-0.00275,-1.58776 -0.00681,-3.17551 -0.01205,-4.76326c-0.01048,-4.3151 -0.00252,-8.62999 0.00875,-12.94508c0.00891,-4.67216 0.00038,-9.34429 -0.00586,-14.01645c-0.00945,-9.13328 -0.00292,-18.26649 0.00926,-27.39976c0.01368,-10.64914 0.01198,-21.29826 0.00987,-31.94741c-0.00318,-19.00686 0.00845,-38.01369 0.02807,-57.02054c0.019,-18.41993 0.02608,-36.83982 0.0205,-55.25976c-0.00606,-20.0882 -0.00586,-40.17638 0.00549,-60.26458c0.00121,-2.144 0.00241,-4.28801 0.00362,-6.43201c0.0006,-1.05473 0.0012,-2.10946 0.00183,-3.19615c0.00387,-7.41354 0.00349,-14.82706 0.00158,-22.2406c-0.00213,-9.03962 0.00314,-18.07919 0.01762,-27.1188c0.00721,-4.60732 0.01134,-9.21458 0.00675,-13.82191c-0.0041,-4.22527 0.00117,-8.45042 0.01363,-12.67568c0.0029,-1.52062 0.00253,-3.04125 -0.00164,-4.56186c-0.088,-35.3061 13.36066,-67.1168 38.0793,-92.24066c25.09379,-24.58771 56.91457,-37.23624 91.84741,-37.06845z" />
                  <path className="fill-gray-100 dark:fill-gray-800" d="m706.75,272.5625c14.52867,11.41538 21.91955,27.43293 24.25,45.4375c0.30028,5.16736 0.33956,10.32556 0.3125,15.5c-0.00149,0.70288 -0.00298,1.40576 -0.00452,2.12994c-0.05337,14.01681 -0.41569,28.25015 -6.35095,41.2099c-0.99192,2.23891 -1.6349,4.42184 -2.26953,6.78516c-3.33012,11.39722 -8.73928,22.00957 -14.84229,32.14697c-2.03982,3.45236 -2.84521,5.11269 -2.84521,9.22803c1.32021,2.02087 1.32021,2.02087 3.125,4c10.60582,13.12282 13.24059,27.47709 11.875,44c-3.71942,32.30163 -22.0958,60.92739 -46.38672,81.97656c-5.62551,4.35578 -11.63243,8.17804 -17.61328,12.02344c0.23783,1.31871 0.23783,1.31871 0.48047,2.66406c2.79823,17.9676 -3.39357,35.1337 -13.23828,49.98828c-1.66653,2.20525 -3.40601,4.28195 -5.24219,6.34766c-1.06734,1.22783 -1.06734,1.22783 -2.15625,2.48047c-2.24564,2.54173 -4.53395,5.03609 -6.84375,7.51953c-0.61359,0.67934 -1.22719,1.35867 -1.85938,2.05859c-14.90034,15.82367 -36.05949,26.40348 -56.14062,33.94141c-0.91137,0.34305 -1.82273,0.6861 -2.76172,1.03955c-15.43832,5.70512 -30.97706,9.46578 -47.23828,11.96045c-1.19432,0.18981 -2.38863,0.37963 -3.61914,0.5752c-7.52049,1.08057 -14.81334,1.54669 -22.41211,1.4873c-0.8559,-0.00289 -1.71179,-0.00578 -2.59363,-0.00876c-3.52144,-0.01454 -7.04032,-0.03143 -10.56067,-0.12552c-10.4001,-0.60158 -10.4001,-0.60158 -19.66113,3.18677c-2.02819,2.53336 -3.60955,5.03647 -5.15332,7.88501c-13.43852,16.43739 -30.85124,26.23072 -51,32c-1.56621,0.47953 -1.56621,0.47953 -3.16406,0.96875c-21.40009,5.85116 -45.49275,1.29688 -64.83594,-8.96875c-19.87178,-11.90732 -32.14351,-28.96022 -41,-50c-0.2736,-0.6484 -0.54721,-1.2968 -0.8291,-1.96484c-8.81076,-21.59159 -8.8168,-46.32906 -5.1709,-69.03516c0.18305,-1.18594 0.36609,-2.37187 0.55469,-3.59375c3.016,-17.12791 9.12736,-33.1931 17.44531,-48.40625c0.73064,-1.37361 1.46111,-2.74731 2.19141,-4.12109c4.60032,-8.52939 9.72859,-16.30539 15.80859,-23.87891c0.7193,-0.91137 1.43859,-1.82273 2.17969,-2.76172c11.58449,-14.44969 24.55493,-28.39267 38.82031,-40.23828c0.74637,-0.63551 1.49273,-1.27102 2.26172,-1.92578c17.41923,-14.59161 36.22922,-27.39647 55.78882,-38.92041c2.2572,-1.33595 4.50588,-2.68568 6.75415,-4.03662c12.45025,-7.47698 24.94843,-14.87076 37.57031,-22.05469c23.7721,-13.54104 47.23171,-27.32097 69.625,-43.0625c0.60151,-0.41991 1.20302,-0.83982 1.82275,-1.27246c8.97452,-6.27017 17.64369,-12.87063 26.17725,-19.72754c0.93457,-0.75023 1.86914,-1.50047 2.83203,-2.27344c14.65826,-11.88972 28.87145,-24.26816 42.125,-37.71484c1.95342,-1.92354 3.96339,-3.72631 6.04297,-5.51172c5.91783,-5.09428 11.43097,-10.56877 16.4375,-16.5625c17.61612,-20.27061 48.027,-28.01643 71.3125,-12.375z" />
                  <path className="fill-gray-50 dark:fill-gray-700" d="m706.75,272.5625c14.52867,11.41538 21.91955,27.43293 24.25,45.4375c0.30028,5.16736 0.33956,10.32556 0.3125,15.5c-0.00149,0.70288 -0.00298,1.40576 -0.00452,2.12994c-0.05337,14.01681 -0.41569,28.25015 -6.35095,41.2099c-0.99192,2.23891 -1.6349,4.42184 -2.26953,6.78516c-3.33012,11.39722 -8.73928,22.00957 -14.84229,32.14697c-2.03982,3.45236 -2.84521,5.11269 -2.84521,9.22803c1.32021,2.02087 1.32021,2.02087 3.125,4c10.60582,13.12282 13.24059,27.47709 11.875,44c-3.71942,32.30163 -22.0958,60.92739 -46.38672,81.97656c-5.62551,4.35578 -11.63243,8.17804 -17.61328,12.02344c0.23783,1.31871 0.23783,1.31871 0.48047,2.66406c2.79823,17.9676 -3.39357,35.1337 -13.23828,49.98828c-1.66653,2.20525 -3.40601,4.28195 -5.24219,6.34766c-1.06734,1.22783 -1.06734,1.22783 -2.15625,2.48047c-2.24564,2.54173 -4.53395,5.03609 -6.84375,7.51953c-0.61359,0.67934 -1.22719,1.35867 -1.85938,2.05859c-14.90034,15.82367 -36.05949,26.40348 -56.14062,33.94141c-0.91137,0.34305 -1.82273,0.6861 -2.76172,1.03955c-15.43832,5.70512 -30.97706,9.46578 -47.23828,11.96045c-1.19432,0.18981 -2.38863,0.37963 -3.61914,0.5752c-7.52049,1.08057 -14.81334,1.54669 -22.41211,1.4873c-0.8559,-0.00289 -1.71179,-0.00578 -2.59363,-0.00876c-3.52144,-0.01454 -7.04032,-0.03143 -10.56067,-0.12552c-10.4001,-0.60158 -10.4001,-0.60158 -19.66113,3.18677c-2.02819,2.53336 -3.60955,5.03647 -5.15332,7.88501c-13.43852,16.43739 -30.85124,26.23072 -51,32c-1.56621,0.47953 -1.56621,0.47953 -3.16406,0.96875c-21.40009,5.85116 -45.49275,1.29688 -64.83594,-8.96875c-19.87178,-11.90732 -32.14351,-28.96022 -41,-50c-0.2736,-0.6484 -0.54721,-1.2968 -0.8291,-1.96484c-8.81076,-21.59159 -8.8168,-46.32906 -5.1709,-69.03516c0.18305,-1.18594 0.36609,-2.37187 0.55469,-3.59375c3.016,-17.12791 9.12736,-33.1931 17.44531,-48.40625c0.73064,-1.37361 1.46111,-2.74731 2.19141,-4.12109c4.60032,-8.52939 9.72859,-16.30539 15.80859,-23.87891c0.7193,-0.91137 1.43859,-1.82273 2.17969,-2.76172c11.58449,-14.44969 24.55493,-28.39267 38.82031,-40.23828c0.74637,-0.63551 1.49273,-1.27102 2.26172,-1.92578c17.41923,-14.59161 36.22922,-27.39647 55.78882,-38.92041c2.2572,-1.33595 4.50588,-2.68568 6.75415,-4.03662c12.45025,-7.47698 24.94843,-14.87076 37.57031,-22.05469c23.7721,-13.54104 47.23171,-27.32097 69.625,-43.0625c0.60151,-0.41991 1.20302,-0.83982 1.82275,-1.27246c8.97452,-6.27017 17.64369,-12.87063 26.17725,-19.72754c0.93457,-0.75023 1.86914,-1.50047 2.83203,-2.27344c14.65826,-11.88972 28.87145,-24.26816 42.125,-37.71484c1.95342,-1.92354 3.96339,-3.72631 6.04297,-5.51172c5.91783,-5.09428 11.43097,-10.56877 16.4375,-16.5625c17.61612,-20.27061 48.027,-28.01643 71.3125,-12.375zm-49.66016,44.08984c-0.81174,0.81836 -1.62348,1.63672 -2.45982,2.47988c-2.57146,2.59467 -5.13248,5.19934 -7.69252,7.80528c-2.56533,2.60059 -5.13287,5.19895 -7.70323,7.79457c-1.59167,1.60841 -3.18022,3.21991 -4.76505,4.83505c-4.11475,4.16967 -8.31566,8.15553 -12.76458,11.96787c-2.33636,2.00793 -4.57678,4.11427 -6.82964,6.21501c-5.20565,4.74675 -10.64795,9.09846 -16.21875,13.40625c-3.05854,2.36579 -6.06657,4.7878 -9.06665,7.22705c-14.54032,11.79049 -29.90168,22.41921 -45.5896,32.6167c-0.7164,0.46696 -1.43279,0.93393 -2.1709,1.41504c-13.79932,8.9568 -28.00407,17.22056 -42.22265,25.48633c-3.41708,1.98702 -6.82875,3.98317 -10.23926,5.98144c-8.43921,4.9416 -16.8785,9.87158 -25.42969,14.61719c-26.35919,14.71098 -52.43064,30.9548 -74.71094,51.45703c-2.04084,1.87256 -4.1212,3.68127 -6.22656,5.48047c-8.52843,7.46452 -16.05309,15.6163 -23,24.5625c-0.65613,0.83918 -1.31227,1.67836 -1.98828,2.54297c-5.63954,7.47041 -10.35397,15.44736 -14.95313,23.58447c-0.84158,1.48869 -1.69761,2.96922 -2.55859,4.44678c-12.32002,22.5732 -18.39799,53.79439 -11.34766,78.84766c0.41959,1.27617 0.41959,1.27617 0.84766,2.57812c0.22816,0.72703 0.45633,1.45406 0.69141,2.20313c5.41369,15.71516 14.64496,28.29064 29.68359,35.73437c12.41825,5.93857 27.64356,6.17953 40.8125,2c16.27247,-6.45848 28.59413,-16.19045 35.90625,-32.35547c3.72445,-10.61147 2.94116,-21.83459 -1.60938,-31.96094c-4.12183,-7.27829 -9.39796,-11.79235 -17.29687,-14.43359c-6.72141,-1.7747 -13.07555,-2.487 -19.5,0.5625c-1.24431,0.7246 -2.47539,1.47273 -3.6875,2.25c-1.33031,0.80437 -1.33031,0.80437 -2.6875,1.625c-5.43376,5.58062 -7.7396,12.90374 -9.3125,20.375c-0.33,0.99 -0.66,1.98 -1,3c-3.02461,0.65275 -5.90007,1.0907 -9,1c-2.5625,-1.75 -2.5625,-1.75 -4,-5c-1.51836,-9.81341 1.41454,-18.78506 7.125,-26.75c7.01416,-8.30977 15.10879,-12.80751 25.875,-14.25c13.17668,-0.91484 24.12687,0.21273 35,8c1.04994,0.72123 1.04994,0.72123 2.12109,1.45703c9.69139,7.46218 15.038,19.71987 16.87891,31.54297c0.44859,3.66496 0.76772,7.31603 1,11c8.72756,0.97871 17.40988,1.24113 26.1875,1.25c1.04623,0.00151 1.04623,0.00151 2.11359,0.00305c13.06711,-0.01265 25.80928,-1.01054 38.69891,-3.25305c0.80534,-0.13922 1.61068,-0.27844 2.44043,-0.42187c27.48066,-4.9693 54.28002,-16.13108 74.55957,-35.57813c0.79535,-0.73219 1.5907,-1.46438 2.41016,-2.21875c7.89976,-7.49093 14.45183,-16.25997 14.90234,-27.46875c0.05844,-2.60267 0.03176,-3.84346 -1.51953,-5.95703c-6.25306,-4.72726 -14.3456,-4.22559 -21.79297,-3.35547c-4.34931,0.88916 -8.62303,2.0659 -12.91089,3.20996c-9.07625,2.29284 -17.7916,2.2682 -27.08911,1.79004c-0.8125,-3.1875 -0.8125,-3.1875 -1,-7c3.17644,-4.39347 6.1864,-5.7233 11.375,-6.875c1.3279,-0.31583 2.65465,-0.63649 3.98047,-0.96094c0.73138,-0.17757 1.46276,-0.35513 2.21631,-0.53808c7.71601,-1.98913 15.3077,-4.48287 22.91455,-6.84912c2.02621,-0.62621 4.05816,-1.2338 6.09179,-1.83545c7.96244,-2.44747 15.21761,-6.11285 22.57227,-9.97168c1.63665,-0.85808 3.28161,-1.70027 4.92773,-2.54004c23.15609,-12.10733 41.77074,-31.38671 50.30469,-56.28906c2.49151,-8.39795 5.05712,-18.80138 1.78125,-27.3125c-1.42121,-2.24402 -2.78302,-3.63761 -5.16406,-4.82813c-15.48861,-2.06515 -34.0235,12.27357 -46.96216,19.61304c-4.9715,2.81233 -9.98899,5.52863 -15.03784,8.19946c-0.68191,0.36094 -1.36383,0.72188 -2.06641,1.09375c-1.32079,0.69529 -2.64369,1.3866 -3.96875,2.07373c-1.32505,0.68788 -2.64532,1.38506 -3.96093,2.09082c-4.56881,2.39462 -8.99198,3.98495 -14.00391,5.1792c-0.66,0.17273 -1.32,0.34547 -2,0.52344c-4.76446,1.1725 -9.09666,1.37979 -14,1.22656c0.55351,-3.32105 1.14091,-6.16244 3,-9c1.31657,-0.69918 2.65347,-1.36041 4,-2c45.16245,-25.348 92.44881,-60.0717 108,-112c4.95631,-18.34732 9.76726,-41.03252 1,-59c-2.19511,-3.05559 -3.85384,-4.90256 -7,-7c-10.49612,-1.67938 -18.19967,7.77737 -24.91016,14.65234z" />
                  <path className="fill-gray-800 dark:fill-gray-200" d="m692,286.9375c2.05078,1.41406 2.05078,1.41406 4,3.0625c0.6948,0.58523 1.38961,1.17047 2.10547,1.77344c9.9517,9.74631 12.72414,23.75752 13.0625,37.17187c0.12281,14.10467 -0.47864,27.61321 -5.16797,41.05469c-0.41623,1.27576 -0.83151,2.55183 -1.24609,3.82813c-6.7357,20.33179 -17.21279,38.57664 -30.75391,55.17187c-1.00558,1.32913 -2.00711,2.66137 -3,4c0.55688,0.02578 1.11375,0.05156 1.6875,0.07813c9.70599,0.72139 15.08636,4.12689 21.55078,11.3125c4.18817,6.20332 5.29427,12.22062 5.19922,19.60937c-0.00612,0.82234 -0.01225,1.64468 -0.01855,2.49194c-0.20605,8.22974 -1.915,15.69956 -4.41895,23.50806c-0.27715,0.87527 -0.5543,1.75055 -0.83984,2.65234c-4.55792,12.62355 -12.12615,24.51482 -21.16016,34.34766c-0.44183,0.4842 -0.88365,0.96841 -1.33887,1.46729c-12.15906,13.17866 -26.67953,22.54191 -42.66113,30.53271c0.95002,2.04211 1.8602,3.82885 3.28906,5.57813c4.86882,6.09313 4.56923,13.06183 3.94141,20.47363c-2.12827,17.99106 -16.55231,33.92892 -30.16406,44.66308c-13.61247,10.14432 -28.02645,18.54526 -44.06641,24.28516c-1.84658,0.69029 -1.84658,0.69029 -3.73047,1.39453c-28.79778,10.42759 -64.88162,16.00623 -95.26953,10.60547c-1.62395,-0.06208 -3.25005,-0.08712 -4.875,-0.0625c-1.17176,0.01354 -1.17176,0.01354 -2.36719,0.02734c-0.58008,0.01161 -1.16015,0.02321 -1.75781,0.03516c-0.44988,0.87141 -0.89977,1.74281 -1.36328,2.64063c-10.20557,19.14017 -25.96469,33.05199 -46.3125,40.75c-19.63111,5.78944 -40.44907,4.22171 -58.44922,-5.39063c-11.85469,-6.76497 -20.14858,-16.16226 -26.875,-28c-0.70125,-1.0725 -1.4025,-2.145 -2.125,-3.25c-13.51272,-24.35769 -12.47575,-56.35891 -5.39844,-82.46484c3.12731,-10.69583 7.14485,-20.73936 12.53369,-30.48975c0.9521,-1.7271 1.86822,-3.47389 2.78272,-5.22119c9.24539,-17.09116 21.57675,-31.83142 35.20703,-45.57422c0.92849,-0.93852 0.92849,-0.93852 1.87573,-1.896c4.21855,-4.24359 8.54355,-8.25138 13.12427,-12.104c0.5427,-0.45649 1.08539,-0.91298 1.64453,-1.3833c24.23622,-20.28551 50.97219,-36.94252 78.35547,-52.6167c4.23086,-2.43457 8.45916,-4.87356 12.6875,-7.3125c1.06501,-0.61384 2.13001,-1.22767 3.22729,-1.86011c27.84146,-15.92119 27.84146,-15.92119 55.08521,-32.82739c0.8843,-0.57541 1.76859,-1.15081 2.67969,-1.74365c28.19269,-18.41966 54.73078,-38.65513 79.40625,-61.58838c2.17412,-1.99051 4.36902,-3.92157 6.60449,-5.84033c4.26236,-3.72504 8.22826,-7.68509 12.17676,-11.7378c1.47741,-1.49979 2.95529,-2.99913 4.43359,-4.49804c2.29078,-2.32783 4.57833,-4.65852 6.85791,-6.99732c2.22684,-2.28175 4.46655,-4.55023 6.7085,-6.81714c1.0005,-1.03617 1.0005,-1.03617 2.02121,-2.09327c10.4034,-10.45955 26.60802,-18.13806 41.1116,-10.74657zm-34.91016,29.71484c-0.81174,0.81836 -1.62348,1.63672 -2.45982,2.47988c-2.57146,2.59467 -5.13248,5.19934 -7.69252,7.80528c-2.56533,2.60059 -5.13287,5.19895 -7.70323,7.79457c-1.59167,1.60841 -3.18022,3.21991 -4.76505,4.83505c-4.11475,4.16967 -8.31566,8.15553 -12.76458,11.96787c-2.33636,2.00793 -4.57678,4.11427 -6.82964,6.21501c-5.20565,4.74675 -10.64795,9.09846 -16.21875,13.40625c-3.05854,2.36579 -6.06657,4.7878 -9.06665,7.22705c-14.54032,11.79049 -29.90168,22.41921 -45.5896,32.6167c-0.7164,0.46696 -1.43279,0.93393 -2.1709,1.41504c-13.79932,8.9568 -28.00407,17.22056 -42.22265,25.48633c-3.41708,1.98702 -6.82875,3.98317 -10.23926,5.98144c-8.43921,4.9416 -16.8785,9.87158 -25.42969,14.61719c-26.35919,14.71098 -52.43064,30.9548 -74.71094,51.45703c-2.04084,1.87256 -4.1212,3.68127 -6.22656,5.48047c-8.52843,7.46452 -16.05309,15.6163 -23,24.5625c-0.65613,0.83918 -1.31227,1.67836 -1.98828,2.54297c-5.63954,7.47041 -10.35397,15.44736 -14.95313,23.58447c-0.84158,1.48869 -1.69761,2.96922 -2.55859,4.44678c-12.32002,22.5732 -18.39799,53.79439 -11.34766,78.84766c0.41959,1.27617 0.41959,1.27617 0.84766,2.57812c0.22816,0.72703 0.45633,1.45406 0.69141,2.20313c5.41369,15.71516 14.64496,28.29064 29.68359,35.73437c12.41825,5.93857 27.64356,6.17953 40.8125,2c16.27247,-6.45848 28.59413,-16.19045 35.90625,-32.35547c3.72445,-10.61147 2.94116,-21.83459 -1.60938,-31.96094c-4.12183,-7.27829 -9.39796,-11.79235 -17.29687,-14.43359c-6.72141,-1.7747 -13.07555,-2.487 -19.5,0.5625c-1.24431,0.7246 -2.47539,1.47273 -3.6875,2.25c-1.33031,0.80437 -1.33031,0.80437 -2.6875,1.625c-5.43376,5.58062 -7.7396,12.90374 -9.3125,20.375c-0.33,0.99 -0.66,1.98 -1,3c-3.02461,0.65275 -5.90007,1.0907 -9,1c-2.5625,-1.75 -2.5625,-1.75 -4,-5c-1.51836,-9.81341 1.41454,-18.78506 7.125,-26.75c7.01416,-8.30977 15.10879,-12.80751 25.875,-14.25c13.17668,-0.91484 24.12687,0.21273 35,8c1.04994,0.72123 1.04994,0.72123 2.12109,1.45703c9.69139,7.46218 15.038,19.71987 16.87891,31.54297c0.44859,3.66496 0.76772,7.31603 1,11c8.72756,0.97871 17.40988,1.24113 26.1875,1.25c1.04623,0.00151 1.04623,0.00151 2.11359,0.00305c13.06711,-0.01265 25.80928,-1.01054 38.69891,-3.25305c0.80534,-0.13922 1.61068,-0.27844 2.44043,-0.42187c27.48066,-4.9693 54.28002,-16.13108 74.55957,-35.57813c0.79535,-0.73219 1.5907,-1.46438 2.41016,-2.21875c7.89976,-7.49093 14.45183,-16.25997 14.90234,-27.46875c0.05844,-2.60267 0.03176,-3.84346 -1.51953,-5.95703c-6.25306,-4.72726 -14.3456,-4.22559 -21.79297,-3.35547c-4.34931,0.88916 -8.62303,2.0659 -12.91089,3.20996c-9.07625,2.29284 -17.7916,2.2682 -27.08911,1.79004c-0.8125,-3.1875 -0.8125,-3.1875 -1,-7c3.17644,-4.39347 6.1864,-5.7233 11.375,-6.875c1.3279,-0.31583 2.65465,-0.63649 3.98047,-0.96094c0.73138,-0.17757 1.46276,-0.35513 2.21631,-0.53808c7.71601,-1.98913 15.3077,-4.48287 22.91455,-6.84912c2.02621,-0.62621 4.05816,-1.2338 6.09179,-1.83545c7.96244,-2.44747 15.21761,-6.11285 22.57227,-9.97168c1.63665,-0.85808 3.28161,-1.70027 4.92773,-2.54004c23.15609,-12.10733 41.77074,-31.38671 50.30469,-56.28906c2.49151,-8.39795 5.05712,-18.80138 1.78125,-27.3125c-1.42121,-2.24402 -2.78302,-3.63761 -5.16406,-4.82813c-15.48861,-2.06515 -34.0235,12.27357 -46.96216,19.61304c-4.9715,2.81233 -9.98899,5.52863 -15.03784,8.19946c-0.68191,0.36094 -1.36383,0.72188 -2.06641,1.09375c-1.32079,0.69529 -2.64369,1.3866 -3.96875,2.07373c-1.32505,0.68788 -2.64532,1.38506 -3.96093,2.09082c-4.56881,2.39462 -8.99198,3.98495 -14.00391,5.1792c-0.66,0.17273 -1.32,0.34547 -2,0.52344c-4.76446,1.1725 -9.09666,1.37979 -14,1.22656c0.55351,-3.32105 1.14091,-6.16244 3,-9c1.31657,-0.69918 2.65347,-1.36041 4,-2c45.16245,-25.348 92.44881,-60.0717 108,-112c4.95631,-18.34732 9.76726,-41.03252 1,-59c-2.19511,-3.05559 -3.85384,-4.90256 -7,-7c-10.49612,-1.67938 -18.19967,7.77737 -24.91016,14.65234z" />
                  <path className="fill-gray-300 dark:fill-gray-500" d="m396,615c0.66,0.33 1.32,0.66 2,1c-2.97,2.97 -5.94,5.94 -9,9c0,-3 0,-3 2.375,-5.5625c0.86625,-0.80437 1.7325,-1.60875 2.625,-2.4375c0.66,-0.66 1.32,-1.32 2,-2z" />
                  <path className="fill-gray-700 dark:fill-gray-300" d="m557,564c0.66,0.33 1.32,0.66 2,1c-0.47437,0.5775 -0.94875,1.155 -1.4375,1.75c-1.51099,2.17582 -2.10286,3.67602 -2.5625,6.25c-0.66,0 -1.32,0 -2,0c0.61538,-5.53846 0.61538,-5.53846 2.5625,-7.875c0.47437,-0.37125 0.94875,-0.7425 1.4375,-1.125z" />
                </svg>
              </div>
              <span className="text-xl lg:text-2xl font-semibold text-gray-900 dark:text-gray-100">{t('layout.appName')}</span>
            </Link>
            
            <nav className="flex items-center space-x-2">
              {navItems.map((item) => {
                // const Icon = item.icon
                const active = isActive(item.path)
                return (
                  <Link
                    key={item.path}
                    to={item.path}
                    className={`
                      flex items-center space-x-2 px-4 lg:px-5 py-2.5 rounded-lg text-[15px] lg:text-base font-medium transition-all duration-150
                      ${active
                      ? 'bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100'
                      : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-100'
                      }
                    `}
                  >
                    {/* <Icon className="w-4.5 h-4.5" /> */}
                    <span>{t(item.labelKey)}</span>
                  </Link>
                )
              })}

              {/* 深色模式切换按钮 */}
              <button
                onClick={toggleTheme}
                className="flex items-center justify-center w-9 h-9 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-100 transition-all duration-150"
                title={theme === 'light' ? '切换到深色模式' : '切换到浅色模式'}
                aria-label="Toggle theme"
              >
                {theme === 'light' ? (
                  <Moon className="w-5 h-5" />
                ) : (
                  <Sun className="w-5 h-5" />
                )}
              </button>

              {/* 语言切换 */}
              <div className="relative ml-2" ref={langMenuRef}>
                <button
                  onClick={() => setShowLangMenu(!showLangMenu)}
                  className="flex items-center space-x-1.5 px-3 py-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-100 transition-all duration-150"
                  title="切换语言 / Switch Language"
                >
                  <Languages className="w-4 h-4" />
                  <span className="text-sm font-medium">{LANGUAGES.find(l => l.code === language)?.nativeName}</span>
                </button>

                {showLangMenu && (
                  <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-50">
                    {LANGUAGES.map((lang) => (
                      <button
                        key={lang.code}
                        onClick={() => {
                          setLanguage(lang.code)
                          setShowLangMenu(false)
                        }}
                        className={`w-full text-left px-4 py-2 text-sm transition-colors ${language === lang.code
                          ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-medium'
                          : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                          }`}
                      >
                        {lang.nativeName}
                      </button>
                    ))}
                  </div>
                )}
              </div>

              {/* 用户菜单（仅在启用认证时显示） */}
              {authEnabled && (
                <div className="relative ml-2" ref={userMenuRef}>
                  <button
                    onClick={() => setShowUserMenu(!showUserMenu)}
                    className="flex items-center space-x-1.5 px-3 py-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-100 transition-all duration-150"
                    title={t('settings.title')}
                  >
                    <span className="text-sm font-medium">{username}</span>
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>

                  {showUserMenu && (
                    <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-50">
                      <button
                        onClick={() => {
                          navigate('/settings')
                          setShowUserMenu(false)
                        }}
                        className="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center space-x-2"
                      >
                        <Settings className="w-4 h-4" />
                        <span>{t('settings.title')}</span>
                      </button>
                      <button
                        onClick={() => {
                          logout()
                          setShowUserMenu(false)
                        }}
                        className="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center space-x-2"
                      >
                        <LogOut className="w-4 h-4" />
                        <span>{t('auth.logout')}</span>
                      </button>
                    </div>
                  )}
                </div>
              )}
            </nav>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1 max-w-[1400px] 2xl:max-w-[1600px] mx-auto px-6 lg:px-10 xl:px-12 py-4 lg:py-6 w-full min-h-[calc(100vh-10rem)]">
        <Outlet />
      </main>

      {/* Footer - 简洁固定 */}
      <footer className="mt-auto py-4 lg:py-4 border-t border-gray-200/60 dark:border-gray-700/60 bg-white/50 dark:bg-gray-900/50" style={{ backdropFilter: 'blur(8px)', WebkitBackdropFilter: 'blur(8px)' }}>
        <div className="max-w-[1400px] 2xl:max-w-[1600px] mx-auto px-6 lg:px-10 xl:px-12">
          <div className="flex items-center justify-between text-[15px] text-gray-500 dark:text-gray-400">
            <div className="flex items-center space-x-4">
              <p>{t('layout.copyright')}</p>
              <span className="text-gray-400 dark:text-gray-600">•</span>
              <p className="text-sm">{t('layout.version')} {CURRENT_VERSION}</p>
            </div>
            <div className="flex items-center space-x-6">
              <a href="https://github.com/browserwing/browserwing" target="_blank" rel="noopener noreferrer" className="hover:text-gray-900 dark:hover:text-gray-100 transition-colors">{t('layout.github')}</a>
              <a href="https://browserwing.com/forums" target="_blank" rel="noopener noreferrer" className="hover:text-gray-900 dark:hover:text-gray-100 transition-colors">{t('layout.community')}</a>
              <a href="https://browserwing.com/docs" target="_blank" rel="noopener noreferrer" className="hover:text-gray-900 dark:hover:text-gray-100 transition-colors">{t('layout.docs')}</a>
              <a href="https://browserwing.com/donate" target="_blank" rel="noopener noreferrer" className="hover:text-gray-900 dark:hover:text-gray-100 transition-colors">{t('layout.donate')}</a>
            </div>
          </div>
        </div>
      </footer>

      {/* 版本更新弹窗 */}
      {showUpdateDialog && latestVersionInfo && (
        <VersionUpdateDialog
          versionInfo={latestVersionInfo}
          onClose={() => setShowUpdateDialog(false)}
          onDismiss={handleDismissUpdate}
        />
      )}
    </div>
  )
}
